var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);i.prototype=e.prototype,t.prototype=new i},h5game;!function(t){var e=function(){function e(e){this.x=0,this.y=0,this.state=t.MapAreaState.MAS_OUT_SCREEN,this._mapLayer=null,this._mapTiles=[],this._mapLayer=e}return e.prototype.addMapTile=function(t){this._mapTiles.push(t)},e.prototype.isInScreen=function(i,r,a,n){return t.RectUtil.isIntersect(this.x,this.y,this.x+e.DEF_SIZE,this.y+e.DEF_SIZE,i,r,i+a,r+n)},e.prototype.refresh=function(e,i,r,a){var n;for(n in this._mapTiles){var o=this._mapTiles[n];t.RectUtil.isIntersect(e,i,e+r,i+a,o.x,o.y,o.x+t.MapTileLayer.DEF_TILE_SIZE,o.y+t.MapTileLayer.DEF_TILE_SIZE)?(o.visible=!0,o.reload()):(o.visible=!1,o.unload())}},e.prototype.unload=function(){var t;for(t in this._mapTiles){var e=this._mapTiles[t];e.visible=!1,e.unload()}},e.DEF_SIZE=1024,e}();t.MapArea=e,__reflect(e.prototype,"h5game.MapArea")}(h5game||(h5game={}));var h5game;!function(t){var e;!function(t){t[t.MAS_OUT_SCREEN=1]="MAS_OUT_SCREEN",t[t.MAS_IN_SCREEN=2]="MAS_IN_SCREEN"}(e=t.MapAreaState||(t.MapAreaState={})),t.MAP_AREA_SIZE=1024}(h5game||(h5game={}));var h5game;!function(t){var e=function(e){function i(){var t=e.call(this)||this;return t._entityLayer=null,t._mapTileLayer=null,t._numLayer=null,t._map_cnf=null,t._city_cnf=null,t._map_id=0,t._width=0,t._height=0,t._tile_width=0,t._tile_height=0,t._curPlayer=null,t._aoiPlayers={},t._monsters={},t._npcs={},t._lastRefreshPt=[0,0],t._mapAreas={},t.addEventListener(egret.TouchEvent.TOUCH_BEGIN,t.onTouchBegin,t),t.addEventListener(egret.TouchEvent.TOUCH_CANCEL,t.onTouchCancel,t),t.addEventListener(egret.TouchEvent.TOUCH_END,t.onTouchEnd,t),t.addEventListener(egret.TouchEvent.TOUCH_MOVE,t.onTouchMove,t),t.initMsgHandler(),t}return __extends(i,e),i.prototype.loadMap=function(e){var i=t.IntfcProxy.getCnfMgr().getConfig("city")[e],r=t.IntfcProxy.getCnfMgr().getMapConfig(e);this._map_id=e,this._map_cnf=r,this._city_cnf=i,this._width=r.map_width,this._height=r.map_height,this._tile_width=r.map_tile_width,this._tile_height=r.map_tile_height,this._mapTileLayer=new t.MapTileLayer,this.addChild(this._mapTileLayer),this._mapTileLayer.loadMap(e),this._entityLayer=new egret.DisplayObjectContainer,this.addChild(this._entityLayer),this._numLayer=new egret.DisplayObjectContainer,this.addChild(this._numLayer),this.initMapArea()},i.prototype.initMapArea=function(){for(var e=Math.ceil(this._width/t.MapArea.DEF_SIZE),i=Math.ceil(this._height/t.MapArea.DEF_SIZE),r=1;i>=r;++r)for(var a=1;e>=a;++a){var n=new t.MapArea(this);n.x=(a-1)*t.MapArea.DEF_SIZE,n.y=(r-1)*t.MapArea.DEF_SIZE,this._mapAreas[(r-1)*e+a]=n}var o=this;this._mapTileLayer.forEachMapTile(function(t,e,i){o.addMapTileToMapArea(t)})},i.prototype.addMapTileToMapArea=function(t){var e=this.getMapAreaByPos(t.x,t.y);e.addMapTile(t)},i.prototype.getMapAreaByPos=function(e,i){var r=Math.floor(e/t.MapArea.DEF_SIZE)+1,a=Math.floor(i/t.MapArea.DEF_SIZE)+1,n=Math.ceil(this._width/t.MapArea.DEF_SIZE),o=(a-1)*n+r;return this._mapAreas[o]},i.prototype.refreshMapArea=function(){var e=-this.x+i.DEF_LOGIC_WIDTH/2,r=-this.y+i.DEF_LOGIC_HEIGHT/2,a=.25*i.DEF_LOGIC_WIDTH,n=.25*i.DEF_LOGIC_HEIGHT;if(!(Math.abs(this._lastRefreshPt[0]-e)<a&&Math.abs(this._lastRefreshPt[1]-r)<n)){this._lastRefreshPt[0]=e,this._lastRefreshPt[1]=r;var o=i.DEF_LOGIC_WIDTH+2*a,s=i.DEF_LOGIC_HEIGHT+2*n,p=e-i.DEF_LOGIC_WIDTH/2-a,h=r-i.DEF_LOGIC_HEIGHT/2-n;for(var _ in this._mapAreas){var c=this._mapAreas[_];if(c.isInScreen(p,h,o,s))c.refresh(p,h,o,s),c.state=t.MapAreaState.MAS_IN_SCREEN;else{var y=c.state;y!=t.MapAreaState.MAS_OUT_SCREEN&&(c.unload(),c.state=t.MapAreaState.MAS_OUT_SCREEN)}}}},i.prototype.initEntities=function(t){this.initCurPlayer(t.curPlayer);for(var e in t.entities.mob){var i=t.entities.mob[e];this.createMonster(i)}for(var e in t.entities.npc){var r=t.entities.npc[e];this.createNpc(r)}},i.prototype.update=function(t){this._curPlayer.update(t);for(var e in this._aoiPlayers){var i=this._aoiPlayers[e];i.update(t)}for(var e in this._monsters){var r=this._monsters[e];r.update(t)}for(var e in this._npcs){var a=this._npcs[e];a.update(t)}this.updateCamera(this._curPlayer.x,this._curPlayer.y),this._mapTileLayer.update(t)},i.prototype.updateCamera=function(t,e){this.x=Math.max(Math.min(0,-(t-i.DEF_LOGIC_WIDTH/2)),-(this._width-i.DEF_LOGIC_WIDTH)),this.y=Math.max(Math.min(0,-(e-i.DEF_LOGIC_HEIGHT/2)),-(this._height-i.DEF_LOGIC_HEIGHT)),this.refreshMapArea()},i.prototype.onTouchBegin=function(t){},i.prototype.onTouchCancel=function(t){},i.prototype.onTouchEnd=function(t){var e=this.globalToLocal(t.stageX,t.stageY);this._curPlayer.moveTo(e.x,e.y)},i.prototype.onTouchMove=function(t){},i.prototype._createPlayer=function(e){var i=new t.Player;return i.init(e,this),this._entityLayer.addChild(i),i},i.prototype.initCurPlayer=function(t){var e=this._createPlayer(t);e.mainPlayer=!0,this._curPlayer=e},i.prototype.createAoiPlayer=function(t){if(this._aoiPlayers[t.entityId])return void console.warn("createAoiPlayer player already exist",JSON.stringify(t));var e=this._createPlayer(t);return this._aoiPlayers[t.entityId]=e,e},i.prototype.removeAoiPlayer=function(t){var e=this.getAoiPlayer(t);e&&(e.release(),e.parent&&e.parent.removeChild(e),delete this._aoiPlayers[t])},i.prototype.getAoiPlayer=function(t){return this._aoiPlayers[t]},i.prototype.createMonster=function(e){if(this._monsters[e.entityId])return void console.warn("createMonster monster already exist",JSON.stringify(e));var i=new t.Monster;return i.init(e,this),this._entityLayer.addChild(i),this._monsters[e.entityId]=i,i},i.prototype.removeMonster=function(t){var e=this.getMonster(t);e&&(e.release(),e.parent&&e.parent.removeChild(e),delete this._monsters[t])},i.prototype.getMonster=function(t){return this._monsters[t]},i.prototype.createNpc=function(e){if(this._npcs[e.entityId])return void console.warn("createNpc npc already exist",JSON.stringify(e));var i=new t.Npc;return i.init(e,this),this._entityLayer.addChild(i),this._npcs[e.entityId]=i,i},i.prototype.removeNpc=function(t){var e=this.getNpc(t);e&&(e.release(),e.parent&&e.parent.removeChild(e),delete this._npcs[t])},i.prototype.getNpc=function(t){return this._npcs[t]},i.prototype.getEntity=function(t){if(this._curPlayer.entityId==t)return this._curPlayer;var e=null;return(e=this._aoiPlayers[t])?e:(e=this._monsters[t])?e:(e=this._npcs[t],e?e:null)},i.prototype.removeEntity=function(e){var i=this.getEntity(e);i&&(i.entityType==t.EntityType.ET_PLAYER?this.removeAoiPlayer(e):i.entityType==t.EntityType.ET_MONSTER?this.removeMonster(e):i.entityType==t.EntityType.ET_NPC&&this.removeNpc(e))},i.prototype.getActor=function(e){var i=this.getEntity(e);return i?i.entityType!=t.EntityType.ET_PLAYER&&i.entityType!=t.EntityType.ET_MONSTER&&i.entityType!=t.EntityType.ET_NPC?null:i:null},i.prototype.createNum=function(t,e,i,r){var a=new egret.DisplayObjectContainer;a.x=t,a.y=e,this._numLayer.addChild(a);var n=new eui.Label;n.size=30,n.stroke=1,n.strokeColor=3355443,n.text=r.toString(),n.width=100,n.anchorOffsetX=n.width/2,a.addChild(n),egret.Tween.get(a).to({y:e-20},500).wait(500).call(function(){a.parent&&a.parent.removeChild(a)})},i.prototype.MsgHandler_onAddEntities=function(t){if(t.mob)for(var e in t.mob){var i=t.mob[e];this.createMonster(i)}if(t.npc)for(var e in t.npc){var r=t.npc[e];this.createNpc(r)}},i.prototype.MsgHandler_onRemoveEntities=function(t){if(t.entities)for(var e in t.entities){var i=t.entities[e];this.removeEntity(i)}},i.prototype.MsgHandler_onMove=function(t){var e=t.path,i=this.getActor(t.entityId);i&&i.moveTo(e[1].x,e[1].y)},i.prototype.MsgHandler_onAttack=function(t){var e=t.skillId,i=this.getActor(t.attacker),r=this.getActor(t.target);i&&r&&(i.stopMove(),i.adjustDir(r.x,r.y),i.execSkill(e,t))},i.prototype.initMsgHandler=function(){var e=this;t.IntfcProxy.getNetMsgHdlr().addMsgHdlr(t.INetMsgOn.INMO_onAddEntities,function(t){e.MsgHandler_onAddEntities(t)}),t.IntfcProxy.getNetMsgHdlr().addMsgHdlr(t.INetMsgOn.INMO_onRemoveEntities,function(t){e.MsgHandler_onRemoveEntities(t)}),t.IntfcProxy.getNetMsgHdlr().addMsgHdlr(t.INetMsgOn.INMO_onMove,function(t){e.MsgHandler_onMove(t)}),t.IntfcProxy.getNetMsgHdlr().addMsgHdlr(t.INetMsgOn.INMO_onAttack,function(t){e.MsgHandler_onAttack(t)})},i.prototype.notify=function(e,i){switch(e){case t.IMapCmdN.IMCN_CreateNum:this.createNum.apply(this,i)}},i.prototype.query=function(e,i){switch(e){case t.IMapCmdQ.IMCQ_GetActor:return this.getActor.apply(this,i)}},i.DEF_LOGIC_WIDTH=640,i.DEF_LOGIC_HEIGHT=1136,i}(egret.DisplayObjectContainer);t.MapLayer=e,__reflect(e.prototype,"h5game.MapLayer")}(h5game||(h5game={}));var h5game;!function(t){var e=function(){function t(){this.source=""}return Object.defineProperty(t.prototype,"x",{get:function(){return this.image.x},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.image.y},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{set:function(t){this.image.visible=t},enumerable:!0,configurable:!0}),t.prototype.reload=function(){this.image.source=this.source},t.prototype.unload=function(){this.image.source=""},t}();t.MapTile=e,__reflect(e.prototype,"h5game.MapTile")}(h5game||(h5game={}));var h5game;!function(t){var e=function(e){function i(){var t=e.call(this)||this;return t.map_id=0,t.map_cnf=null,t.city_cnf=null,t._widht=0,t._height=0,t._ver="",t._mapTiles=[],t}return __extends(i,e),i.getImagePath=function(t,e,i){return"resource/map/"+t+"/"+e+"X"+i+".jpg"},i.prototype.update=function(t){},i.prototype.loadMap=function(e){var i=t.IntfcProxy.getCnfMgr().getConfig("city")[e],r=t.IntfcProxy.getCnfMgr().getMapConfig(e);this.map_id=e,this.map_cnf=r,this.city_cnf=i,this._widht=i.width,this._height=i.height,this._ver=i.ver?i.ver:"",this.createMapTile()},i.prototype.createMapTile=function(){for(var e=i.DEF_TILE_SIZE,r=Math.floor((this._widht-1)/e+1),a=Math.floor((this._height-1)/e+1),n=1;a>=n;n++)for(var o=1;r>=o;o++){var s=i.getImagePath(this.map_cnf.map_res,n,o);this._ver&&this._ver.length&&(s+="?v="+this._ver);var p=new eui.Image;p.x=e*(o-1),p.y=e*(n-1),this.addChild(p);var h=new t.MapTile;h.source=s,h.image=p,this._mapTiles.push(h)}},i.prototype.forEachMapTile=function(t){this._mapTiles.forEach(t)},i.DEF_TILE_SIZE=512,i}(egret.DisplayObjectContainer);t.MapTileLayer=e,__reflect(e.prototype,"h5game.MapTileLayer")}(h5game||(h5game={}));