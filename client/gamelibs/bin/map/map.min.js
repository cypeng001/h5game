var __reflect=this&&this.__reflect||function(t,e,r){t.__class__=e,r?r.push(e):r=[e],t.__types__=t.__types__?r.concat(t.__types__):r},__extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);r.prototype=e.prototype,t.prototype=new r},h5game;!function(t){var e=function(){function e(e){this.x=0,this.y=0,this.state=t.MapAreaState.MAS_OUT_SCREEN,this._mapLayer=null,this._mapTiles=[],this._mapLayer=e}return e.prototype.addMapTile=function(t){this._mapTiles.push(t)},e.prototype.isInScreen=function(r,i,a,n){return t.RectUtil.isIntersect(this.x,this.y,this.x+e.DEF_SIZE,this.y+e.DEF_SIZE,r,i,r+a,i+n)},e.prototype.refresh=function(e,r,i,a){var n;for(n in this._mapTiles){var o=this._mapTiles[n];t.RectUtil.isIntersect(e,r,e+i,r+a,o.x,o.y,o.x+t.MapTileLayer.DEF_TILE_SIZE,o.y+t.MapTileLayer.DEF_TILE_SIZE)?(o.visible=!0,o.reload()):(o.visible=!1,o.unload())}},e.prototype.unload=function(){var t;for(t in this._mapTiles){var e=this._mapTiles[t];e.visible=!1,e.unload()}},e.DEF_SIZE=1024,e}();t.MapArea=e,__reflect(e.prototype,"h5game.MapArea")}(h5game||(h5game={}));var h5game;!function(t){var e;!function(t){t[t.MAS_OUT_SCREEN=1]="MAS_OUT_SCREEN",t[t.MAS_IN_SCREEN=2]="MAS_IN_SCREEN"}(e=t.MapAreaState||(t.MapAreaState={})),t.MAP_AREA_SIZE=1024}(h5game||(h5game={}));var h5game;!function(t){var e=function(e){function r(){var t=e.call(this)||this;return t._entityLayer=null,t._mapTileLayer=null,t._numLayer=null,t._map_cnf=null,t._city_cnf=null,t._map_id=0,t._width=0,t._height=0,t._tile_width=0,t._tile_height=0,t._curPlayer=null,t._aoiPlayers={},t._monsters={},t._npcs={},t._transports={},t._lastRefreshPt=[0,0],t._mapAreas={},t.addEventListener(egret.TouchEvent.TOUCH_BEGIN,t.onTouchBegin,t),t.addEventListener(egret.TouchEvent.TOUCH_CANCEL,t.onTouchCancel,t),t.addEventListener(egret.TouchEvent.TOUCH_END,t.onTouchEnd,t),t.addEventListener(egret.TouchEvent.TOUCH_TAP,t.onTouchTab,t),t.addEventListener(egret.TouchEvent.TOUCH_MOVE,t.onTouchMove,t),t.initMsgHandler(),t}return __extends(r,e),r.prototype.loadMap=function(e){var r=t.IntfcProxy.getCnfMgr().getConfig("city")[e],i=t.IntfcProxy.getCnfMgr().getMapConfig(e);this._map_id=e,this._map_cnf=i,this._city_cnf=r,this._width=i.map_width,this._height=i.map_height,this._tile_width=i.map_tile_width,this._tile_height=i.map_tile_height,this._mapTileLayer=new t.MapTileLayer,this.addChild(this._mapTileLayer),this._mapTileLayer.loadMap(e),this._entityLayer=new egret.DisplayObjectContainer,this.addChild(this._entityLayer),this._numLayer=new egret.DisplayObjectContainer,this.addChild(this._numLayer),this.loadStaticObject(),this.initMapArea()},r.prototype.loadStaticObject=function(){if(this._map_cnf.npc_list)for(var t in this._map_cnf.npc_list){var e=this._map_cnf.npc_list[t];this.createNpc(e)}if(this._map_cnf.transport_list)for(var t in this._map_cnf.transport_list){var r=this._map_cnf.transport_list[t];this.createTransport(r)}},r.prototype.initMapArea=function(){for(var e=Math.ceil(this._width/t.MapArea.DEF_SIZE),r=Math.ceil(this._height/t.MapArea.DEF_SIZE),i=1;r>=i;++i)for(var a=1;e>=a;++a){var n=new t.MapArea(this);n.x=(a-1)*t.MapArea.DEF_SIZE,n.y=(i-1)*t.MapArea.DEF_SIZE,this._mapAreas[(i-1)*e+a]=n}var o=this;this._mapTileLayer.forEachMapTile(function(t,e,r){o.addMapTileToMapArea(t)})},r.prototype.addMapTileToMapArea=function(t){var e=this.getMapAreaByPos(t.x,t.y);e.addMapTile(t)},r.prototype.getMapAreaByPos=function(e,r){var i=Math.floor(e/t.MapArea.DEF_SIZE)+1,a=Math.floor(r/t.MapArea.DEF_SIZE)+1,n=Math.ceil(this._width/t.MapArea.DEF_SIZE),o=(a-1)*n+i;return this._mapAreas[o]},r.prototype.refreshMapArea=function(){var e=-this.x+r.DEF_LOGIC_WIDTH/2,i=-this.y+r.DEF_LOGIC_HEIGHT/2,a=.25*r.DEF_LOGIC_WIDTH,n=.25*r.DEF_LOGIC_HEIGHT;if(!(Math.abs(this._lastRefreshPt[0]-e)<a&&Math.abs(this._lastRefreshPt[1]-i)<n)){this._lastRefreshPt[0]=e,this._lastRefreshPt[1]=i;var o=r.DEF_LOGIC_WIDTH+2*a,s=r.DEF_LOGIC_HEIGHT+2*n,p=e-r.DEF_LOGIC_WIDTH/2-a,h=i-r.DEF_LOGIC_HEIGHT/2-n;for(var _ in this._mapAreas){var c=this._mapAreas[_];if(c.isInScreen(p,h,o,s))c.refresh(p,h,o,s),c.state=t.MapAreaState.MAS_IN_SCREEN;else{var y=c.state;y!=t.MapAreaState.MAS_OUT_SCREEN&&(c.unload(),c.state=t.MapAreaState.MAS_OUT_SCREEN)}}}},r.prototype.initEntities=function(t){this.initCurPlayer(t.curPlayer);for(var e in t.entities.mob){var r=t.entities.mob[e];this.createMonster(r)}for(var e in t.entities.npc){var i=t.entities.npc[e];this.createNpc(i)}},r.prototype.update=function(t){this._curPlayer.update(t);for(var e in this._aoiPlayers){var r=this._aoiPlayers[e];r.update(t)}for(var e in this._monsters){var i=this._monsters[e];i.update(t)}for(var e in this._npcs){var a=this._npcs[e];a.update(t)}for(var e in this._transports){var n=this._transports[e];n.update(t)}this.updateCamera(this._curPlayer.x,this._curPlayer.y),this._mapTileLayer.update(t)},r.prototype.updateCamera=function(t,e){this.x=Math.max(Math.min(0,-(t-r.DEF_LOGIC_WIDTH/2)),-(this._width-r.DEF_LOGIC_WIDTH)),this.y=Math.max(Math.min(0,-(e-r.DEF_LOGIC_HEIGHT/2)),-(this._height-r.DEF_LOGIC_HEIGHT)),this.refreshMapArea()},r.prototype.onTouchBegin=function(t){},r.prototype.onTouchCancel=function(t){},r.prototype.onTouchEnd=function(t){},r.prototype.onTouchTab=function(t){var e=this.globalToLocal(t.stageX,t.stageY);this._curPlayer.moveTo(e.x,e.y)},r.prototype.onTouchMove=function(t){},r.prototype._createPlayer=function(e){var r=new t.Player;return r.init(e,this),this._entityLayer.addChild(r),r},r.prototype.initCurPlayer=function(t){var e=this._createPlayer(t);e.mainPlayer=!0,this._curPlayer=e},r.prototype.createAoiPlayer=function(t){if(this._aoiPlayers[t.entityId])return void console.warn("createAoiPlayer player already exist",JSON.stringify(t));var e=this._createPlayer(t);return this._aoiPlayers[t.entityId]=e,e},r.prototype.removeAoiPlayer=function(t){var e=this.getAoiPlayer(t);e&&(e.release(),e.parent&&e.parent.removeChild(e),delete this._aoiPlayers[t])},r.prototype.getAoiPlayer=function(t){return this._aoiPlayers[t]},r.prototype.createMonster=function(e){if(this._monsters[e.entityId])return void console.warn("createMonster monster already exist",JSON.stringify(e));var r=new t.Monster;return r.init(e,this),this._entityLayer.addChild(r),this._monsters[e.entityId]=r,r},r.prototype.removeMonster=function(t){var e=this.getMonster(t);e&&(e.release(),e.parent&&e.parent.removeChild(e),delete this._monsters[t])},r.prototype.getMonster=function(t){return this._monsters[t]},r.prototype.createNpc=function(e){if(this._npcs[e.entityId])return void console.warn("createNpc npc already exist",JSON.stringify(e));var r=new t.Npc;return r.init(e,this),this._entityLayer.addChild(r),this._npcs[e.entityId]=r,r},r.prototype.removeNpc=function(t){var e=this.getNpc(t);e&&(e.release(),e.parent&&e.parent.removeChild(e),delete this._npcs[t])},r.prototype.getNpc=function(t){return this._npcs[t]},r.prototype.getEntity=function(t){if(this._curPlayer.entityId==t)return this._curPlayer;var e=null;return(e=this._aoiPlayers[t])?e:(e=this._monsters[t])?e:(e=this._npcs[t],e?e:null)},r.prototype.removeEntity=function(e){var r=this.getEntity(e);r&&(r.entityType==t.EntityType.ET_PLAYER?this.removeAoiPlayer(e):r.entityType==t.EntityType.ET_MONSTER?this.removeMonster(e):r.entityType==t.EntityType.ET_NPC&&this.removeNpc(e))},r.prototype.getActor=function(e){var r=this.getEntity(e);return r?r.entityType!=t.EntityType.ET_PLAYER&&r.entityType!=t.EntityType.ET_MONSTER&&r.entityType!=t.EntityType.ET_NPC?null:r:null},r.prototype.createTransport=function(e){if(this._transports[e.entityId])return void console.warn("createTransport transport already exist",JSON.stringify(e));var r=new t.Transport;return r.init(e,this),this._entityLayer.addChild(r),this._transports[e.entityId]=r,r},r.prototype.removeTransport=function(t){var e=this.getTransport(t);e&&(e.release(),e.parent&&e.parent.removeChild(e),delete this._transports[t])},r.prototype.getTransport=function(t){return this._transports[t]},r.prototype.createNum=function(t,e,r,i){var a=new egret.DisplayObjectContainer;a.x=t,a.y=e,this._numLayer.addChild(a);var n=new eui.BitmapLabel;n.font="font_pz_zi_j1_fnt",n.letterSpacing=-3,n.text=i.toString(),n.width=100,n.anchorOffsetX=n.width/2,a.addChild(n),egret.Tween.get(a).to({y:e-20},500).wait(500).call(function(){a.parent&&a.parent.removeChild(a)})},r.prototype.MsgHandler_onAddEntities=function(t){if(t.mob)for(var e in t.mob){var r=t.mob[e];this.createMonster(r)}if(t.npc)for(var e in t.npc){var i=t.npc[e];this.createNpc(i)}},r.prototype.MsgHandler_onRemoveEntities=function(t){if(t.entities)for(var e in t.entities){var r=t.entities[e];this.removeEntity(r)}},r.prototype.MsgHandler_onMove=function(t){var e=t.path,r=this.getActor(t.entityId);r&&r.moveTo(e[1].x,e[1].y)},r.prototype.MsgHandler_onAttack=function(t){var e=t.skillId,r=this.getActor(t.attacker),i=this.getActor(t.target);r&&i&&(r.stopMove(),r.adjustDir(i.x,i.y),r.execSkill(e,t))},r.prototype.initMsgHandler=function(){var e=this;t.IntfcProxy.getNetMsgHdlr().addMsgHdlr(t.INetMsgOn.INMO_AREA_onAddEntities,function(t){e.MsgHandler_onAddEntities(t)}),t.IntfcProxy.getNetMsgHdlr().addMsgHdlr(t.INetMsgOn.INMO_AREA_onRemoveEntities,function(t){e.MsgHandler_onRemoveEntities(t)}),t.IntfcProxy.getNetMsgHdlr().addMsgHdlr(t.INetMsgOn.INMO_AREA_onMove,function(t){e.MsgHandler_onMove(t)}),t.IntfcProxy.getNetMsgHdlr().addMsgHdlr(t.INetMsgOn.INMO_FIGHT_onAttack,function(t){e.MsgHandler_onAttack(t)})},r.prototype.notify=function(e,r){switch(e){case t.IMapCmdN.IMCN_CreateNum:this.createNum.apply(this,r)}},r.prototype.query=function(e,r){switch(e){case t.IMapCmdQ.IMCQ_GetActor:return this.getActor.apply(this,r)}},r.DEF_LOGIC_WIDTH=640,r.DEF_LOGIC_HEIGHT=924,r}(egret.DisplayObjectContainer);t.MapLayer=e,__reflect(e.prototype,"h5game.MapLayer")}(h5game||(h5game={}));var h5game;!function(t){var e=function(){function t(){this.source=""}return Object.defineProperty(t.prototype,"x",{get:function(){return this.image.x},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"y",{get:function(){return this.image.y},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{set:function(t){this.image.visible=t},enumerable:!0,configurable:!0}),t.prototype.reload=function(){this.image.source=this.source},t.prototype.unload=function(){this.image.source=""},t}();t.MapTile=e,__reflect(e.prototype,"h5game.MapTile")}(h5game||(h5game={}));var h5game;!function(t){var e=function(e){function r(){var t=e.call(this)||this;return t.map_id=0,t.map_cnf=null,t.city_cnf=null,t._widht=0,t._height=0,t._ver="",t._mapTiles=[],t}return __extends(r,e),r.getImagePath=function(t,e,r){return"resource/map/"+t+"/"+e+"X"+r+".jpg"},r.prototype.update=function(t){},r.prototype.loadMap=function(e){var r=t.IntfcProxy.getCnfMgr().getConfig("city")[e],i=t.IntfcProxy.getCnfMgr().getMapConfig(e);this.map_id=e,this.map_cnf=i,this.city_cnf=r,this._widht=r.width,this._height=r.height,this._ver=r.ver?r.ver:"",this.createMapTile()},r.prototype.createMapTile=function(){for(var e=r.DEF_TILE_SIZE,i=Math.floor((this._widht-1)/e+1),a=Math.floor((this._height-1)/e+1),n=1;a>=n;n++)for(var o=1;i>=o;o++){var s=r.getImagePath(this.map_cnf.map_res,n,o);this._ver&&this._ver.length&&(s+="?v="+this._ver);var p=new eui.Image;p.x=e*(o-1),p.y=e*(n-1),this.addChild(p);var h=new t.MapTile;h.source=s,h.image=p,this._mapTiles.push(h)}},r.prototype.forEachMapTile=function(t){this._mapTiles.forEach(t)},r.DEF_TILE_SIZE=512,r}(egret.DisplayObjectContainer);t.MapTileLayer=e,__reflect(e.prototype,"h5game.MapTileLayer")}(h5game||(h5game={}));