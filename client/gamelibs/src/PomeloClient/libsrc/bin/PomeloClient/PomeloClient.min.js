(function(L,p){function q(a){if(a)return G(a)}function G(a){for(var b in q.prototype)a[b]=q.prototype[b];return a}function A(a,b){if(!b)return!1;for(var c in b){var d=b[c];switch(d.option){case "required":if("undefined"===typeof a[c])return!1;break;case "optional":"undefined"!==typeof a[c]&&b.__messages[d.type]&&A(a[c],b.__messages[d.type]);break;case "repeated":if(a[c]&&b.__messages[d.type])for(var e=0;e<a[c].length;e++)if(!A(a[c][e],b.__messages[d.type]))return!1}}return!0}function H(a,b,c,d){for(var e in d)if(c[e]){var f=
c[e];switch(f.option){case "required":case "optional":b=r(a,b,B(f.type,f.tag));b=C(d[e],f.type,b,a,c);break;case "repeated":if(0<d[e].length){var h=d[e],y=a,k=c,g;if(util.isSimpleType(f.type))for(b=r(y,b,B(f.type,f.tag)),b=r(y,b,l.codec.encodeUInt32(h.length)),g=0;g<h.length;g++)b=C(h[g],f.type,b,y);else for(g=0;g<h.length;g++)b=r(y,b,B(f.type,f.tag)),b=C(h[g],f.type,b,y,k)}}}return b}function C(a,b,c,d,e){var f=l.codec;switch(b){case "uInt32":c=r(d,c,f.encodeUInt32(a));break;case "int32":case "sInt32":c=
r(d,c,f.encodeSInt32(a));break;case "float":r(d,c,f.encodeFloat(a));c+=4;break;case "double":r(d,c,f.encodeDouble(a));c+=8;break;case "string":b=f.byteLength(a);c=r(d,c,f.encodeUInt32(b));f.encodeStr(d,c,a);c+=b;break;default:if(e.__messages[b]){var h=new ArrayBuffer(f.byteLength(JSON.stringify(a)));b=H(h,0,e.__messages[b],a);c=r(d,c,f.encodeUInt32(b));for(a=0;a<b;a++)d[c]=h[a],c++}}return c}function r(a,b,c){for(var d=0;d<c.length;d++,b++)a[b]=c[d];return b}function B(a,b){return l.codec.encodeUInt32(b<<
3|(l.constants.TYPES[a]||2))}function I(a,b,c){for(var d;h.offset<c;){d=l.codec.decodeUInt32(w())>>3;var e=b.__tags[d];switch(b[e].option){case "optional":case "required":a[e]=D(b[e].type,b);break;case "repeated":a[e]||(a[e]=[]);d=a[e];e=b[e].type;var f=b;if(M.isSimpleType(e)){f=l.codec.decodeUInt32(w());for(var g=0;g<f;g++)d.push(D(e))}else d.push(D(e,f))}}return a}function D(a,b){var c=l.codec;switch(a){case "uInt32":return c.decodeUInt32(w());case "int32":case "sInt32":return c.decodeSInt32(w());
case "float":var d=c.decodeFloat(h.buffer,h.offset);h.offset+=4;return d;case "double":return d=c.decodeDouble(h.buffer,h.offset),h.offset+=8,d;case "string":return d=c.decodeUInt32(w()),c=c.decodeStr(h.buffer,h.offset,d),h.offset+=d,c;default:if(b&&b.__messages[a])return d=c.decodeUInt32(w()),c={},I(c,b.__messages[a],h.offset+d),c}}function w(a){var b=[],c=h.offset;a=a||!1;do{var d=h.buffer[c];b.push(d);c++}while(128<=d);a||(h.offset=c);return b}q.prototype.on=function(a,b){this._callbacks=this._callbacks||
{};(this._callbacks[a]=this._callbacks[a]||[]).push(b);return this};q.prototype.once=function(a,b){function c(){d.off(a,c);b.apply(this,arguments)}var d=this;this._callbacks=this._callbacks||{};b._off=c;this.on(a,c);return this};q.prototype.off=q.prototype.removeListener=q.prototype.removeAllListeners=function(a,b){this._callbacks=this._callbacks||{};if(0==arguments.length)return this._callbacks={},this;var c=this._callbacks[a];if(!c)return this;if(1==arguments.length)return delete this._callbacks[a],
this;var d=index(c,b._off||b);~d&&c.splice(d,1);return this};q.prototype.emit=function(a){this._callbacks=this._callbacks||{};var b=[].slice.call(arguments,1),c=this._callbacks[a];if(c){c=c.slice(0);for(var d=0,e=c.length;d<e;++d)c[d].apply(this,b)}return this};q.prototype.listeners=function(a){this._callbacks=this._callbacks||{};return this._callbacks[a]||[]};q.prototype.hasListeners=function(a){return!!this.listeners(a).length};var t={Package:{TYPE_HANDSHAKE:1,TYPE_HANDSHAKE_ACK:2,TYPE_HEARTBEAT:3,
TYPE_DATA:4,TYPE_KICK:5},Message:{TYPE_REQUEST:0,TYPE_NOTIFY:1,TYPE_RESPONSE:2,TYPE_PUSH:3}},g=t.Package,m=t.Message;t.strencode=function(a){for(var b=new p(3*a.length),c=0,d=0;d<a.length;d++){var e=a.charCodeAt(d);e=127>=e?[e]:2047>=e?[192|e>>6,128|e&63]:[224|e>>12,128|(e&4032)>>6,128|e&63];for(var f=0;f<e.length;f++)b[c]=e[f],++c}a=new p(c);u(a,0,b,0,c);return a};t.strdecode=function(a){a=new p(a);for(var b=[],c=0,d,e=a.length;c<e;)128>a[c]?(d=a[c],c+=1):224>a[c]?(d=((a[c]&63)<<6)+(a[c+1]&63),c+=
2):(d=((a[c]&15)<<12)+((a[c+1]&63)<<6)+(a[c+2]&63),c+=3),b.push(d);return String.fromCharCode.apply(null,b)};g.encode=function(a,b){var c=b?b.length:0,d=new p(4+c),e=0;d[e++]=a&255;d[e++]=c>>16&255;d[e++]=c>>8&255;d[e++]=c&255;b&&u(d,e,b,0,c);return d};g.decode=function(a){a=new p(a);var b=a[0],c=1,d=(c=(a[c++]<<16|a[c++]<<8|a[c++])>>>0)?new p(c):null;u(d,0,a,4,c);return{type:b,body:d}};m.encode=function(a,b,c,d,e){if(E(b)){var f=a;var h=0;do h+=1,f>>=7;while(0<f);f=h}else f=0;h=f;f=1+h;if(F(b))if(c){if("number"!==
typeof d)throw Error("error flag for number route!");f+=2}else if(f+=1,d){d=t.strencode(d);if(255<d.length)throw Error("route maxlength is overflow");f+=d.length}e&&(f+=e.length);f=new p(f);if(b!==m.TYPE_REQUEST&&b!==m.TYPE_NOTIFY&&b!==m.TYPE_RESPONSE&&b!==m.TYPE_PUSH)throw Error("unkonw message type: "+b);f[0]=b<<1|(c?1:0);var g=1;if(E(b)){var k=g+h-1;for(f[k--]=a&127;k>=g;)a>>=7,f[k--]=a&127|128;g+=h}if(F(b)){b=d;d=g;if(c){if(65535<b)throw Error("route number is overflow");f[d++]=b>>8&255;f[d++]=
b&255}else b?(f[d++]=b.length&255,u(f,d,b,0,b.length),d+=b.length):f[d++]=0;g=d}e&&u(f,g,e,0,e.length);return f};m.decode=function(a){a=new p(a);var b=a.length||a.byteLength,c=0,d=0,e=null,f=a[c++],h=f&1;f=f>>1&7;if(E(f)){var g=a[c++];for(d=g&127;g&128;)d<<=7,g=a[c++],d|=g&127}F(f)&&(h?e=a[c++]<<8|a[c++]:((g=a[c++])?(e=new p(g),u(e,0,a,c,g),e=t.strdecode(e)):e="",c+=g));b-=c;g=new p(b);u(g,0,a,c,b);return{id:d,type:f,compressRoute:h,route:e,body:g}};var u=function(a,b,c,d,e){if("function"===typeof c.copy)c.copy(a,
b,d,d+e);else for(var f=0;f<e;f++)a[b++]=c[d++]},E=function(a){return a===m.TYPE_REQUEST||a===m.TYPE_RESPONSE},F=function(a){return a===m.TYPE_REQUEST||a===m.TYPE_NOTIFY||a===m.TYPE_PUSH},l={init:function(a){l.encoder.init(a.encoderProtos);l.decoder.init(a.decoderProtos)},encode:function(a,b){return l.encoder.encode(a,b)},decode:function(a,b){return l.decoder.decode(a,b)}};(l.constants={}).TYPES={uInt32:0,sInt32:0,int32:0,"double":1,string:2,message:2,"float":5};var M={isSimpleType:function(a){return"uInt32"===
a||"sInt32"===a||"int32"===a||"uInt64"===a||"sInt64"===a||"float"===a||"double"===a}},n=l.codec={},x=new ArrayBuffer(8),J=new Float32Array(x),K=new Float64Array(x),z=new Uint8Array(x);n.encodeUInt32=function(a){a=parseInt(a);if(isNaN(a)||0>a)return null;var b=[];do{var c=a%128;a=Math.floor(a/128);0!==a&&(c+=128);b.push(c)}while(0!==a);return b};n.encodeSInt32=function(a){a=parseInt(a);if(isNaN(a))return null;a=0>a?2*Math.abs(a)-1:2*a;return n.encodeUInt32(a)};n.decodeUInt32=function(a){for(var b=
0,c=0;c<a.length;c++){var d=parseInt(a[c]);b+=(d&127)*Math.pow(2,7*c);if(128>d)break}return b};n.decodeSInt32=function(a){a=this.decodeUInt32(a);return(a%2+a)/2*(1===a%2?-1:1)};n.encodeFloat=function(a){J[0]=a;return z};n.decodeFloat=function(a,b){if(!a||a.length<b+4)return null;for(var c=0;4>c;c++)z[c]=a[b+c];return J[0]};n.encodeDouble=function(a){K[0]=a;return z.subarray(0,8)};n.decodeDouble=function(a,b){if(!a||a.length<8+b)return null;for(var c=0;8>c;c++)z[c]=a[b+c];return K[0]};n.encodeStr=
function(a,b,c){for(var d=0;d<c.length;d++){var e=c.charCodeAt(d);e=127>=e?[e]:2047>=e?[192|e>>6,128|e&63]:[224|e>>12,128|(e&4032)>>6,128|e&63];for(var f=0;f<e.length;f++)a[b]=e[f],b++}return b};n.decodeStr=function(a,b,c){var d=[];for(c=b+c;b<c;){if(128>a[b]){var e=a[b];b+=1}else 224>a[b]?(e=((a[b]&63)<<6)+(a[b+1]&63),b+=2):(e=((a[b]&15)<<12)+((a[b+1]&63)<<6)+(a[b+2]&63),b+=3);d.push(e)}a="";for(b=0;b<d.length;)a+=String.fromCharCode.apply(null,d.slice(b,b+1E4)),b+=1E4;return a};n.byteLength=function(a){if("string"!==
typeof a)return-1;for(var b=0,c=0;c<a.length;c++){var d=a.charCodeAt(c);d=127>=d?1:2047>=d?2:3;b+=d}return b};x=l.encoder={};x.init=function(a){this.protos=a||{}};x.encode=function(a,b){var c=this.protos[a];if(!A(b,c))return null;var d=l.codec.byteLength(JSON.stringify(b));d=new ArrayBuffer(d);d=new Uint8Array(d);return c&&(c=H(d,0,c,b),0<c)?d.subarray(0,c):null};var h=l.decoder={};h.buffer=0;h.offset=0;h.init=function(a){this.protos=a||{}};h.setProtos=function(a){a&&(this.protos=a)};h.decode=function(a,
b){var c=this.protos[a];h.buffer=b;h.offset=0;return c?I({},c,h.buffer.length):null};var v=function(){this.socket=null;this.callbacks={};this.handlers={};this.routeMap={};this.nextHeartbeatTimeout=this.heartbeatTimeout=this.heartbeatInterval=0;this.gapThreshold=100;this.handshakeCallback=this.heartbeatTimeoutId=this.heartbeatId=null;this.handshakeBuffer={sys:{type:"js-websocket",version:"0.0.5"},user:{}};this.initCallback=null;this.handlers[g.TYPE_HANDSHAKE]=this.handshake;this.handlers[g.TYPE_HEARTBEAT]=
this.heartbeat;this.handlers[g.TYPE_DATA]=this.onData;this.handlers[g.TYPE_KICK]=this.onKick};L.Pomelo=v;v.reqId=0;var k=v.prototype;G(k);k.init=function(a,b){this.initCallback=b;var c=a.port,d="ws://"+a.host;c&&(d+=":"+c);this.handshakeBuffer.user=a.user;this.handshakeCallback=a.handshakeCallback;this.initWebSocket(d,b)};k.initWebSocket=function(a,b){console.log("connect to "+a);var c=this;this.socket=new WebSocket(a);this.socket.binaryType="arraybuffer";this.socket.onopen=function(a){a=g.encode(g.TYPE_HANDSHAKE,
t.strencode(JSON.stringify(c.handshakeBuffer)));c.send(a)};this.socket.onmessage=function(a){c.processPackage(g.decode(a.data),b);c.heartbeatTimeout&&(c.nextHeartbeatTimeout=Date.now()+c.heartbeatTimeout)};this.socket.onerror=function(a){c.emit("io-error",a);console.error("socket error: ",a)};this.socket.onclose=function(b){c.emit("close",b,a);console.error("socket close: ",b)}};k.disconnect=function(){var a=this.socket;a&&(a.disconnect&&a.disconnect(),a.close&&a.close(),console.log("disconnect"),
this.socket=null);this.heartbeatId&&(clearTimeout(this.heartbeatId),this.heartbeatId=null);this.heartbeatTimeoutId&&(clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null)};k.request=function(a,b,c){2===arguments.length&&"function"===typeof b?(c=b,b={}):b=b||{};if(a=a||b.route)v.reqId++,this.sendMessage(v.reqId,a,b),this.callbacks[v.reqId]=c,this.routeMap[v.reqId]=a};k.notify=function(a,b){b=b||{};this.sendMessage(0,a,b)};k.sendMessage=function(a,b,c){var d=a?m.TYPE_REQUEST:m.TYPE_NOTIFY;
c=(this.data.protos?this.data.protos.client:{})[b]?l.encode(b,c):t.strencode(JSON.stringify(c));var e=0;this.dict&&this.dict[b]&&(b=this.dict[b],e=1);c=m.encode(a,d,e,b,c);a=g.encode(g.TYPE_DATA,c);this.send(a)};k.send=function(a){this.socket.send(a.buffer)};k.heartbeat=function(a){if(this.heartbeatInterval){var b=g.encode(g.TYPE_HEARTBEAT);this.heartbeatTimeoutId&&(clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=null);if(!this.heartbeatId){var c=this;this.heartbeatId=setTimeout(function(){c.heartbeatId=
null;c.send(b);c.nextHeartbeatTimeout=Date.now()+c.heartbeatTimeout;c.heartbeatTimeoutId=setTimeout(c.heartbeatTimeoutCb.bind(c),c.heartbeatTimeout)},this.heartbeatInterval)}}};k.heartbeatTimeoutCb=function(){var a=this.nextHeartbeatTimeout-Date.now();a>this.gapThreshold?this.heartbeatTimeoutId=setTimeout(this.heartbeatTimeoutCb.bind(this),a):(console.error("server heartbeat timeout"),this.emit("heartbeat timeout"),this.disconnect())};k.handshake=function(a){a=JSON.parse(t.strdecode(a));if(501===
a.code)this.emit("error","client version not fullfill");else if(200!==a.code)this.emit("error","handshake fail");else{this.handshakeInit(a);var b=g.encode(g.TYPE_HANDSHAKE_ACK);this.send(b);this.initCallback&&(this.initCallback(a),this.initCallback=null)}};k.onData=function(a){a=m.decode(a);if(0<a.id&&(a.route=this.routeMap[a.id],delete this.routeMap[a.id],!a.route))return;a.body=this.deCompose(a);this.processMessage(k,a)};k.onKick=function(a){this.emit("onKick")};k.processPackage=function(a){this.handlers[a.type].apply(this,
[a.body])};k.processMessage=function(a,b){if(b.id){var c=this.callbacks[b.id];delete this.callbacks[b.id];"function"===typeof c&&c(b.body)}else this.emit(b.route,b.body)};k.deCompose=function(a){var b=this.data.protos?this.data.protos.server:{},c=this.data.abbrs,d=a.route;if(a.compressRoute){if(!c[d])return{};d=a.route=c[d]}return b[d]?l.decode(d,a.body):JSON.parse(t.strdecode(a.body))};k.handshakeInit=function(a){a.sys&&a.sys.heartbeat?(this.heartbeatInterval=1E3*a.sys.heartbeat,this.heartbeatTimeout=
2*this.heartbeatInterval):this.heartbeatTimeout=this.heartbeatInterval=0;this.initData(a);"function"===typeof this.handshakeCallback&&this.handshakeCallback(a.user)};k.initData=function(a){if(a&&a.sys){this.data=a||{};var b=a.sys.dict,c=a.sys.protos;if(b){a.dict=b;a.abbrs={};for(var d in b)a.abbrs[b[d]]=d}c&&(a.protos={server:c.server||{},client:c.client||{}},l.init({encoderProtos:c.client,decoderProtos:c.server}))}}})(window,Uint8Array);